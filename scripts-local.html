
{% include_relative listeners.html %}

<script>
// vim: ts=3



//////////////////////////////
//
// displayShortcut --
//

function displayShortcut(entry) {
	var path = entry["@path"];
	if (path.length > 0) {
		displayLevel(MENUDATA, path[0]["@title"]);
	}
	if (path.length > 1) {
		displayLevel(path[0], path[1]["@title"]);
	}
	if (path.length > 2) {
		displayLevel(path[1], path[2]["@title"]);
	}
	if (path.length > 3) {
		displayLevel(path[2], path[3]["@title"]);
	}
	if (path.length > 4) {
		displayLevel(path[3], path[4]["@title"]);
	}
}



//////////////////////////////
//
// displayLevel --
//

function displayLevel(menudata, selection) {
	var list = [];
	for (var key in menudata) {
		if (typeof menudata[key] === "string") {
			continue;
		}
		if (menudata[key]["@level"]) {
			list.push(menudata[key]);
		}
	}
	list = list.sort(function(a, b) {
		return a["@line"] - b["@line"];
	});
	if (list.length == 0) {
		if (menudata) {
			displayPdfButton(menudata);
			displayInfo(menudata);
		}
		return;
	}

	var level = list[0]["@level"];
	clearLevelsStartingAt(level);

	var output = "";
	output += "<select onchange='updateList(" + level + ")'>";
	for (var i=0; i<list.length; i++) {
		output += "<option value='" + list[i]["@title"] + "'";
		if (selection && selection === list[i]["@title"]) {
			output += " selected";
		}
		output += ">";
		output += list[i]["@title"].replace(/ZZZ/g, "'")
			.replace(/-flat/g, "&flat;")
			.replace(/-sharp/g, "&sharp;");
		output += "</option>";
	}
	output += "</select>";
	var selector = "#level" + level;
	var element = document.querySelector(selector);
	if (element) {
		element.innerHTML = output;
	}

	if (list.length >= 1) {
		displayLevel(list[0]);
	}
}



//////////////////////////////
//
// displayInfo --
//

function displayInfo(menudata) {
	if (!menudata) {
		console.log("Error: entry is not defined");
		return;
	}
	var dataurl = menudata.dataurl;
	var wikiurl = menudata.wikiurl;

	var element = document.querySelector("div#info");
	if (!element) {
		console.log("Error: could not found info div");
		return;
	}
	var output = "";
	output += "<ul style='padding-bottom:0; margin-bottom:0;'>";

	if (wikiurl && !wikiurl.match(/^\s*$/)) {
		output += "<li>";
		output += "<a target='data' href='" + wikiurl + "'>";
		output += "Associated website: ";
		output += wikiurl.replace(/http[s]:\/\//, "");
		output += "</a>";
		output += "</li>";
	}

	if (dataurl && !dataurl.match(/^\s*$/)) {
		var bburl = dataurl.replace(/\/raw\//, "/src/");
		output += "<li>";
		output += "<a target='data' href='" + bburl + "'>";
		output += "Source data for PDF on BitBucket";
		output += "</a>";
		
		output += "</li>";
	}

	if (dataurl && !dataurl.match(/^\s*$/)) {
		output += "<li>";
		output += "<a target='data' href='" + dataurl + "'>";
		output += "Raw data";
		if (dataurl.match(/\.md2/)) {
			output += " (Musedata stage 2 format)";
		} else if (dataurl.match(/\.iff/)) {
			output += " (page-layout file format)";
		}
		output += "</a>";
		
		output += "</li>";
	}

	if (dataurl && !dataurl.match(/^\s*$/)) {
		var newurl = dataurl.replace(/raw\/.*/, "") + "issues";
		output += "<li>";
		output += "<a target='data' href='" + newurl + "'>";
		output += "Report problem with music/data";
		output += "</a>";
		
		output += "</li>";
	}

	if (dataurl && dataurl.match(/\.md2$/)) {
		output += "<li>";
		output += "N.B.: automatic typesetting from symbolic data";
		output += "</li>";
	}

	element.innerHTML = output;
}



//////////////////////////////
//
// displayPdfButton --
//

function displayPdfButton(menudata) {
	if (!menudata) {
		console.log("Error: entry is not defined");
		return;
	}
	var shortcut = menudata.shortcut;
	if (!shortcut) {
		console.log("Error: shortcut was not found in", menudata);
		return;
	}
	var abutton = document.querySelector("#actionbuttons");
	if (!abutton) {
		console.log("Error: button location is not available");
		return;
	}
	var output = "";
	output += "<div class='pdfbutton' onclick='generatePdf(\"" + shortcut + "\")'>Generate Music PDF</div>";
	abutton.innerHTML = output;
}



//////////////////////////////
//
// generatePdf --
//

function generatePdf(id) {
	var url = "http://pdf.musedata.org?id=" + id;
	window.open(url, "_blank");
}



//////////////////////////////
//
// updateList --
//

function updateList(level) {
	clearLevelsStartingAt(level+1);
	var path = [];
	var levels = document.querySelector("#levels");
	var i;
	for (i=1; i<=level; i++) {
		var element = levels.querySelector("#level" + i + " select");
		if (!element) {
			continue;
		}
		path.push(element.value);
	}
	var obj = MENUDATA;
	for (i=0; i<path.length; i++) {
		obj = obj[path[i]];
	}
	displayLevel(obj);
}



//////////////////////////////
//
// clearLevelsStartingAt --
//

function clearLevelsStartingAt(level) {
	var levels = document.querySelector("#levels");
	var level1;
	var level2;
	var level3;
	var level4;
	var level5;

	if (level <= 5) {
		var level5 = levels.querySelector("#level5");
		level5.innerHTML = "";
	}

	if (level <= 4) {
		var level4 = levels.querySelector("#level4");
		level4.innerHTML = "";
	}

	if (level <= 3) {
		var level3 = levels.querySelector("#level3");
		level3.innerHTML = "";
	}

	if (level <= 2) {
		var level2 = levels.querySelector("#level2");
		level2.innerHTML = "";
	}

	if (level <= 1) {
		var level1 = levels.querySelector("#level1");
		level1.innerHTML = "";
	}

	var buttons = document.querySelector("#actionbuttons");
	if (buttons) {
		buttons.innerHTML = "";
	}
}




</script>




