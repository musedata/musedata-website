
{% include_relative listeners.html %}

<script>
// vim: ts=3



//////////////////////////////
//
// displayShortcut --
//

function displayShortcut(entry) {
	var path = entry["@path"];
	if (path.length > 0) {
		displayLevel(MENUDATA, path[0]["@title"]);
	}
	if (path.length > 1) {
		displayLevel(path[0], path[1]["@title"]);
	}
	if (path.length > 2) {
		displayLevel(path[1], path[2]["@title"]);
	}
	if (path.length > 3) {
		displayLevel(path[2], path[3]["@title"]);
	}
	if (path.length > 4) {
		displayLevel(path[3], path[4]["@title"]);
	}
}



//////////////////////////////
//
// displayLevel --
//

function displayLevel(menudata, selection) {
	var list = [];
	for (var key in menudata) {
		if (typeof menudata[key] === "string") {
			continue;
		}
		if (menudata[key]["@level"]) {
			list.push(menudata[key]);
		}
	}
	list = list.sort(function(a, b) {
		return a["@line"] - b["@line"];
	});
	if (list.length == 0) {
		if (menudata) {
			displayPdfButton(menudata);
			displayInfo(menudata);
		}
		return;
	}

	var level = list[0]["@level"];
	clearLevelsStartingAt(level);

	var output = "";
	output += "<select onchange='updateList(" + level + ")'>";
	for (var i=0; i<list.length; i++) {
		output += "<option value='" + list[i]["@title"] + "'";
		if (selection && selection === list[i]["@title"]) {
			output += " selected";
		}
		output += ">";
		output += list[i]["@title"].replace(/ZZZ/g, "'")
			.replace(/-flat/g, "&flat;")
			.replace(/-sharp/g, "&sharp;");
		output += "</option>";
	}
	output += "</select>";
	var selector = "#level" + level;
	var element = document.querySelector(selector);
	if (element) {
		element.innerHTML = output;
	}

	if (list.length >= 1) {
		displayLevel(list[0]);
	}
}



//////////////////////////////
//
// displayInfo --
//

function displayInfo(menudata) {
	if (!menudata) {
		console.log("Error: entry is not defined");
		return;
	}
	var dataurl = menudata.dataurl;
	var infourl = menudata.url;

	var element = document.querySelector("div#info");
	if (!element) {
		console.log("Error: could not found info div");
		return;
	}
	var output = "";
	output += "<ul style='padding-bottom:0; margin-bottom:0;'>";

	if (infourl && !infourl.match(/^\s*$/)) {
		output += "<li>";
		output += "See: <a target='data' href='" + infourl + "'>";
		output += infourl.replace(/http[s]:\/\//, "");
		output += "</a>";
		output += "</li>";
	}

	if (dataurl && !dataurl.match(/^\s*$/)) {
		var bburl;
		if (dataurl.match(/bitbucket/)) {
			// https://bitbucket.org/musedata/beethoven/raw/master/bhl/orch/sym9/editions/public/score/mvt4a.md2
			// to:
			// https://bitbucket.org/musedata/beethoven/src/master/bhl/orch/sym9/editions/public/score/mvt4a.md2
			bburl = dataurl.replace(/\/raw\//, "/src/");
		} else if (dataurl.match(/github/)) {
			// https://raw.githubusercontent.com/josquin-research-project/Jos/master/Jos2830-Scaramella.krn
			// to:
			// https://github.com/josquin-research-project/Jos/blob/master/Jos2830-Scaramella.krn
			bburl = dataurl.replace(/raw\.githubusercontent\.com/, "/github.com/").replace(/master/, "/blob/master/").replace(/\/+/g, "/").replace("musedata.org/", "");;
		}
		output += "<li>";
console.log("BBURL", bburl);
		output += "<a target='data' href='" + bburl + "'>";
		output += "Source data for PDF on";
		if (dataurl.match(/bitbucket/)) {
			output += " bitbucket";
		} else if (dataurl.match(/github/)) {
			output += " github";
		}
		output += "</a>";
		
		output += "</li>";
	}

	if (dataurl && !dataurl.match(/^\s*$/)) {
		output += "<li>";
		output += "<a target='data' href='" + dataurl + "'>";
		output += "Raw data";
		if (dataurl.match(/\.md2/)) {
			output += " (Musedata file)";
		} else if (dataurl.match(/\.msd/)) {
			output += " (Musedata file)";
		} else if (dataurl.match(/\.iff/)) {
			output += " (page-layout file)";
		} else if (dataurl.match(/\.krn/)) {
			output += " (Humdrum file)";
		}
		output += "</a>";
		
		output += "</li>";
	}


//	if (dataurl && !dataurl.match(/^\s*$/)) {
//		var newurl = dataurl.replace(/raw\/.*/, "") + "issues";
//		output += "<li>";
//		output += "<a target='data' href='" + newurl + "'>";
//		output += "Report problem with music/data";
//		output += "</a>";
//		output += "</li>";
//	}

	if (dataurl && dataurl.match(/\.md2$/)) {
		output += "<li>";
		output += "N.B.: automatic typesetting from symbolic data";
		output += "</li>";
	}

	element.innerHTML = output;
}



//////////////////////////////
//
// displayPdfButton --
//

function displayPdfButton(menudata) {
	if (!menudata) {
		console.log("Error: entry is not defined");
		return;
	}
	var shortcut = menudata.shortcut;
	if (!shortcut) {
		console.log("Error: shortcut was not found in", menudata);
		return;
	}
	var abutton = document.querySelector("#actionbuttons");
	if (!abutton) {
		console.log("Error: button location is not available");
		return;
	}
	var output = "";
	output += "<div class='pdfbutton' onclick='generatePdf(\"" + shortcut + "\")'>Download PDF</div>";
	abutton.innerHTML = output;
}



//////////////////////////////
//
// generatePdf --
//

function generatePdf(id) {
	var url = "http://pdf.musedata.org?id=" + id;
	window.open(url, "_blank");
}



//////////////////////////////
//
// updateList --
//

function updateList(level) {
	clearLevelsStartingAt(level+1);
	var path = [];
	var levels = document.querySelector("#levels");
	var i;
	for (i=1; i<=level; i++) {
		var element = levels.querySelector("#level" + i + " select");
		if (!element) {
			continue;
		}
		path.push(element.value);
	}
	var obj = MENUDATA;
	for (i=0; i<path.length; i++) {
		obj = obj[path[i]];
	}
	displayLevel(obj);
}



//////////////////////////////
//
// clearLevelsStartingAt --
//

function clearLevelsStartingAt(level) {
	var levels = document.querySelector("#levels");
	var level1;
	var level2;
	var level3;
	var level4;
	var level5;

	if (level <= 5) {
		var level5 = levels.querySelector("#level5");
		level5.innerHTML = "";
	}

	if (level <= 4) {
		var level4 = levels.querySelector("#level4");
		level4.innerHTML = "";
	}

	if (level <= 3) {
		var level3 = levels.querySelector("#level3");
		level3.innerHTML = "";
	}

	if (level <= 2) {
		var level2 = levels.querySelector("#level2");
		level2.innerHTML = "";
	}

	if (level <= 1) {
		var level1 = levels.querySelector("#level1");
		level1.innerHTML = "";
	}

	var buttons = document.querySelector("#actionbuttons");
	if (buttons) {
		buttons.innerHTML = "";
	}
}



//////////////////////////////
//
// displayFlatList --
//

function displayFlatList(list) {
	var element = document.querySelector("#flat-list");
	if (!element) {
		console.log("Error: #list not found");
		return;
	}
	element.innerHTML = "";
	var output = "";
	output += "<table class='list'>";

	var i;
	// var different;

	for (i=0; i<list.length; i++) {
		//if (isPart(list[i])) {
		//	continue;
		//}
		[content, i] = printEntry(list, i);
		output += content;
	}

	output += "</table>";
	element.innerHTML = output;
}



//////////////////////////////
//
// printEntry -- Print one line of the flat listing table.
//

function printEntry(list, index) {
	var obj = list[index];
	var oobj;
	if (index > 0) {
		oobj = list[index-1];
	} else {
		oobj = null;
	}
	var output = "";
	var text;
	var newindex = index;
	var content;
	var partQ;
	var path = obj["@path"];
	output += "<tr>";
	var colspan = 0;
	for (i=0; i<path.length; i++) {
		colspan = 0;
		if (i == path.length - 1) {
			colspan = 5 - path.length + 1;
			if (colspan < 1) {
				colspan = 0;
			}
		}
		output += "<td class='hanging-indent' ";
		if (colspan) {
			output += 'colspan="' + colspan + '" ';
		}
		partQ = isPart(obj);
		if (partQ) {
			output += " class='parts'";
		}
		output += ">";
		if (oobj && oobj["@path"][i] 
				&& (path[i]["@title"] === oobj["@path"][i]["@title"])
				&& (!path[i]["@title"].match(/part/i))
				) {
			text = cleanText(path[i]["@title"])
			output += "<div class='hidden-cell'>";
			output += formatText(text);
			output += "</div>";
			continue;
		}
		if (i < path.length) {
			text = cleanText(path[i]["@title"])
			if (text.match(/^parts?/i)) {
				output += "<i>" + text + ":</i>";
				[content, newindex] = printParts(list, index)
				output += " " + content;
				break;
			} else if (i == path.length - 1) {
				output += "<a target='pdf' href='";
				output += "http://pdf.musedata.org/?id=" + list[index].shortcut;
				output += "'>";
				output += formatText(text);
				output += "</a>";
			} else {
				output += text;
			}
		}
		output += "</td>";
	}
	output += "</tr>";
	return [output, newindex];
}



//////////////////////////////
//
// formatText -- Force non-breaking spaces after certain abbreviations.
//

function formatText(text) {
	return text
			.replace(/RV\s+/g, "RV&nbsp;")
			.replace(/op\.\s+/g, "op.&nbsp;")
			.replace(/no\.\s+/g, "no.&nbsp;");
}



//////////////////////////////
//
// isPart --
//

function isPart(obj) {
	var path = obj["@path"];
	if (!path) {
		console.log("Error: no path in object to check");
		return 0;
	}
	if (path.length < 2) {
		console.log("Warning: path too short");
		return 0;
	}	
	if (path[path.length-2]["@title"].match(/^parts?/i)) {
		return 1;
	}
	return 0;
}



//////////////////////////////
//
// printParts --
//

function printParts(list, index) {
	var obj = list[index];
	var path = list[index]["@path"];
	var output = "";
	output += "<a target='pdf' href='";
	output += "http://pdf.musedata.org/?id=" + list[index].shortcut;
	output += "'>";
	output += path[path.length-1]["@title"];
	output += "</a>";

	var i = index+1;

	while (areSameXPart(list[i], list[i-1])) {
		path = list[i]["@path"];
		output += ", ";
		output += "<a target='pdf' href='";
		output += "http://pdf.musedata.org/?id=" + list[i].shortcut;
		output += "'>";
		output += path[path.length-1]["@title"];
		output += "</a>";
		i++;
		if (list[i] == null) {
			break;
		}
	}

	return [output, i-1];
}


//////////////////////////////
//
// selectTypesettingGroup --
//

function selectTypesettingGroup() {
	var element = document.querySelector("select#data-type");
	if (!element) {
		return;
	}
	var value = element.value;
	if (value === "automatic") {
		LIST = LIST_AUTOMATIC;
		SHORTCUTS = SHORTCUTS_AUTOMATIC;
		MENUDATA = MENUDATA_AUTOMATIC;
	} else if (value === "manual") {
		LIST = LIST_MANUAL;
		SHORTCUTS = SHORTCUTS_MANUAL;
		MENUDATA = MENUDATA_MANUAL;
	} else {
		LIST = LIST_BOTH;
		SHORTCUTS = SHORTCUTS_BOTH;
		MENUDATA = MENUDATA_BOTH;
	}

	doAction(MENUDATA);
}


//////////////////////////////
//
// areSameXPart --
//

function areSameXPart(obj1, obj2) {
	if (obj1["@path"].length != obj2["@path"].length) {
		return 0;
	}
	for (var i=0; i<obj1["@path"].length; i++) {
		if (obj1["@path"][i]["@title"] !== obj2["@path"][i]["@title"]) {
			return 0;
		}
		if (obj1["@path"][i]["@title"].match(/^parts?/i)) {
			break;
		}
	}
	return 1;
}



//////////////////////////////
//
// cleanText --
//

function cleanText(text) {
	return text.replace(/-flat/g, "&flat;").replace(/-sharp/g, "&sharp;").replace(/ZZZ/g, "'");
}



</script>




